---
apiVersion: v1
kind: ConfigMap
metadata:
  name: opa-nifi-uif-rego
  labels:
    opa.stackable.tech/bundle: "true"
data:
  roles.rego: |
    package nifi

    default allow := {
      "allowed": "false", 
      "dumpCache": true
    }

    allow := {
      "allowed": "true", 
      "dumpCache": true
    } if {
      input.user.name == "CN=generated certificate for pod"
      input.resource.id == "/proxy"
    }

    allow := {
      "allowed": "true", 
      "dumpCache": true
    } if {
      group_paths := data.stackable.opa.userinfo.v1.userInfoByUsername(input.user.name).groups
      roles := [ trim(group,"/") | group := group_paths[_] ]
      some i
      roles[i] == "nifi-admin"
    }

